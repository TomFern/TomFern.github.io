<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.26.2 by Michael Rose
  Copyright 2013-2024 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->

<html lang="en-US" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Unused Index cleanup - Chaos is order undeciphered</title>
<meta name="description" content="Removing unused indexes for improved performance.">


  <meta name="author" content="Tommy Fernandez">
  
  <meta property="article:author" content="Tommy Fernandez">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Chaos is order undeciphered">
<meta property="og:title" content="Unused Index cleanup">
<meta property="og:url" content="https://tomfern.com/post/unused-index-cleanup">


  <meta property="og:description" content="Removing unused indexes for improved performance.">



  <meta property="og:image" content="https://tomfern.com/images/avatar.webp">



  <meta name="twitter:site" content="@tomfernblog">
  <meta name="twitter:title" content="Unused Index cleanup">
  <meta name="twitter:description" content="Removing unused indexes for improved performance.">
  <meta name="twitter:url" content="https://tomfern.com/post/unused-index-cleanup">

  
    <meta name="twitter:card" content="summary">
    
      <meta name="twitter:image" content="https://tomfern.com/images/avatar.webp">
    
  

  



  <meta property="article:published_time" content="2019-01-09T19:15:00+00:00">






<link rel="canonical" href="https://tomfern.com/post/unused-index-cleanup">












<!-- end _includes/seo.html -->



  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Chaos is order undeciphered Feed">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script type="text/javascript">
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
  
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css"></noscript>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          Chaos is order undeciphered
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a
                href="/about"
                
                
              >About</a>
            </li><li class="masthead__menu-item">
              <a
                href="/tags/"
                
                
              >Tags</a>
            </li><li class="masthead__menu-item">
              <a
                href="https://semaphoreci.com/author/tfernandez"
                
                
              >My posts</a>
            </li><li class="masthead__menu-item">
              <a
                href="https://www.youtube.com/playlist?list=PL9pxz3ccLeug2c74TKysCC-7ErP0dkqAk"
                
                
              >My videos</a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      





<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person" class="h-card">

  
    <div class="author__avatar">
      <a href="https://tomfern.com/">
        <img src="/images/avatar.webp" alt="Tommy Fernandez" itemprop="image" class="u-photo">
      </a>
    </div>
  

  <div class="author__content">
    <h3 class="author__name p-name" itemprop="name">
      <a class="u-url" rel="me" href="https://tomfern.com/" itemprop="url">Tommy Fernandez</a>
    </h3>
    
      <div class="author__bio p-note" itemprop="description">
        <p>Technical writer and content creator</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name" class="p-locality">Portugal</span>
        </li>
      

      
        
          
            <li><a href="/feed.xml" rel="nofollow noopener noreferrer me"><i class="fas fa-fw fa-rss" aria-hidden="true"></i><span class="label">RSS</span></a></li>
          
        
          
            <li><a href="https://twitter.com/tomfernblog" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i><span class="label">Twitter</span></a></li>
          
        
          
            <li><a href="https://www.linkedin.com/in/pablo-tomas-fernandez-b6077514/" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-brands fa-linkedin" aria-hidden="true"></i><span class="label">LinkedIn</span></a></li>
          
        
          
            <li><a href="https://github.com/tomfern" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer me">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Unused Index cleanup">
    <meta itemprop="description" content="Removing unused indexes for improved performance.">
    <meta itemprop="datePublished" content="2019-01-09T19:15:00+00:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">
            <a href="https://tomfern.com/post/unused-index-cleanup" itemprop="url">Unused Index cleanup
</a>
          </h1>
          

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          2 minute read
        
      </span>
    
  </p>


        </header>
      

      <section class="page__content" itemprop="text">
        
        <p><img src="/images/database.jpg" alt="" /></p>

<p>Fixing a query by finding the right index feels great, as if by magic, things are blazing fast again.</p>

<p>But indexes, like everything in life, needs balancing. As things inevitably change, some indexes will be left abandoned and unused.
What happens then? Well, the database engine must keep them updated regardless, that’s wasted I/O. They also take up space. Pruning indexes is
the life of any dba.</p>

<h2 id="unused-indexes-in-mysql">Unused Indexes in MySQL</h2>

<p>Fortunately in MySQL has are two great tools: the <em>performance_schema</em>, which collects all kind of metrics and the <em>sys</em> schema which offers easier-to-read views.</p>

<p>The first thing to do is ensure that performance_schema is enabled and configured. There is a global configuration setting to enable it, requires restart to take effect.</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code># my.cnf
# ~~~~~~

[mysqld]
performance_schema=ON
</code></pre></div></div>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-- check if performance_schema is enabled
select @@performance_schema;
</code></pre></div></div>

<p>Then there is the runtime configuration to control what types of events to log. This is quite a complex subject because there is so many knobs to turn.</p>

<p>We’ll cheat, we have indexes to delete, no time to be reading manuals. MySQL Workbench has a <em>Performance Schema Setup</em> wizard.</p>

<p><img src="/images/performance_schema_setup.png" alt="performance schema setup" /></p>

<p><img src="/images/sys_installer.png" alt="installing the sys schema" /></p>

<p>Setting the slider to at least <em>Server Default</em> should be enough.</p>

<p><img src="/images/performance_schema_slider.png" alt=" cheat mode: enabled" /></p>

<h2 id="the-catch">The Catch</h2>

<p>Once everything is set up, we’ll find unused indexes in a view.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">sys</span><span class="p">.</span><span class="n">schema_unused_indexes</span>
</code></pre></div></div>

<p>The documentation states:</p>

<blockquote>
  <p>The <a href="https://dev.mysql.com/doc/refman/8.0/en/sys-schema-unused-indexes.html">schema_unused_indexes</a> View</p>

  <p>These views display indexes for which there are no events, which indicates that they are not being used. By default, rows are sorted by schema and table.</p>

  <p>This view is most useful when the server has been up and processing long enough that its workload is representative. Otherwise, presence of an index in this view may not be meaningful.</p>
</blockquote>

<p>At first glance it seems that we need only to check that the server has been running for some time,
i.e. the performance counters are reset on service restart.</p>

<p>That’s not entirely true, because all the counters for a particular table are also reset when any of its indexes are <strong>modified</strong>.
Doing any <code class="language-plaintext highlighter-rouge">alter table [add|remove] index</code>, marks all the other indexes on that table table as unused.</p>

<p>If you wish to have some fun test it yourself:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">create</span> <span class="k">database</span> <span class="n">super</span><span class="p">;</span>
<span class="k">create</span> <span class="k">table</span> <span class="n">super</span><span class="p">.</span><span class="n">heroes</span> <span class="p">(</span>
  <span class="n">name</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">45</span><span class="p">)</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
  <span class="n">hability</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">45</span><span class="p">)</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
  <span class="k">key</span><span class="p">(</span><span class="n">name</span><span class="p">),</span>
  <span class="k">key</span><span class="p">(</span><span class="n">hability</span><span class="p">)</span>
<span class="p">);</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">super</span><span class="p">.</span><span class="n">heroes</span> <span class="k">values</span>
<span class="p">(</span><span class="s1">'the flash'</span><span class="p">,</span><span class="s1">'speed'</span><span class="p">),</span>
<span class="p">(</span><span class="s1">'aquaman'</span><span class="p">,</span><span class="s1">'fish language'</span><span class="p">),</span>
<span class="p">(</span><span class="s1">'batman'</span><span class="p">,</span><span class="s1">'rich'</span><span class="p">),</span>
<span class="p">(</span><span class="s1">'superman'</span><span class="p">,</span><span class="s1">'all of them'</span><span class="p">);</span>

<span class="c1">-- use the index and check the counters</span>
<span class="k">select</span> <span class="n">name</span> <span class="k">from</span> <span class="n">super</span><span class="p">.</span><span class="n">heroes</span><span class="p">;</span>
<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">sys</span><span class="p">.</span><span class="n">schema_unused_indexes</span><span class="p">;</span>

<span class="c1">-- any one of these resets the index usage counters</span>
<span class="k">alter</span> <span class="k">table</span> <span class="n">super</span><span class="p">.</span><span class="n">heroes</span> <span class="k">add</span> <span class="k">key</span> <span class="n">name_hability</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">hability</span><span class="p">);</span>
<span class="k">alter</span> <span class="k">table</span> <span class="n">super</span><span class="p">.</span><span class="n">heroes</span> <span class="k">drop</span> <span class="k">key</span> <span class="n">name_hability</span><span class="p">;</span>
</code></pre></div></div>

<h2 id="related-links">Related Links</h2>

<ul>
  <li>performance_schema quickstart: <a href="https://dev.mysql.com/doc/mysql-perfschema-excerpt/8.0/en/performance-schema-quick-start.html">https://dev.mysql.com/doc/mysql-perfschema-excerpt/8.0/en/performance-schema-quick-start.html</a></li>
  <li>performance_schema config: <a href="https://dev.mysql.com/doc/mysql-perfschema-excerpt/8.0/en/performance-schema-runtime-configuration.html">https://dev.mysql.com/doc/mysql-perfschema-excerpt/8.0/en/performance-schema-runtime-configuration.html</a></li>
  <li>schema_unused_indexes: <a href="https://dev.mysql.com/doc/refman/8.0/en/sys-schema-unused-indexes.html">https://dev.mysql.com/doc/refman/8.0/en/sys-schema-unused-indexes.html</a></li>
</ul>

<h2 id="a-final-word">A Final Word</h2>

<p>Here’s my general strategy:</p>

<ul>
  <li>Backup the tables, or at the very least export the index definitions (just in case)</li>
  <li>Ensure that both server has been running for enough time <strong>and</strong> that the table has not been modified recently</li>
</ul>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>show table status from &lt;SCHEMA&gt; where name = &lt;TABLE&gt;
</code></pre></div></div>

<ul>
  <li>Save the list of the unused indexes somewhere safe, you’ll probably lose it after modifying the table</li>
</ul>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>create table unused_backup as select * from sys.schema_unused_indexes
</code></pre></div></div>

<ul>
  <li>Delete the unused indexes</li>
</ul>

<p>Hope that helps.</p>

<p>Tomas</p>

        
      </section>

      <footer class="page__meta">
        
        
  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      <a href="/tags/#mysql" class="page__taxonomy-item p-category" rel="tag">mysql</a>
    
    </span>
  </p>




        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time class="dt-published" datetime="2019-01-09T19:15:00+00:00">January 9, 2019</time></p>

      </footer>

      <section class="page__share">
  

  <a href="https://twitter.com/intent/tweet?via=tomfernblog&text=Unused+Index+cleanup%20https%3A%2F%2Ftomfern.com%2Fpost%2Funused-index-cleanup" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Ftomfern.com%2Fpost%2Funused-index-cleanup" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://tomfern.com/post/unused-index-cleanup" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/post/sysbench-guide-2" class="pagination--pager" title="Sysbench for databases
">Previous</a>
    
    
      <a href="/post/cost-of-idle-indexes" class="pagination--pager" title="The Cost of Idle Indexes
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
    
<div class="page__related">
  
  <h2 class="page__related-title">You May Also Enjoy</h2>
  <div class="grid__wrapper">
    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/post/writing-in-markdown" rel="permalink">Better Markdown for Writers
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          2 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">This is how I organize my writing projects.
</p>
  </article>
</div>

    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/post/my-writing-process" rel="permalink">My Writing Process
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          4 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">The process I use from research to publication in my work as a full-time technical writer
</p>
  </article>
</div>

    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/post/always-use-imagepullsecrets" rel="permalink">Always use ImagePullSecrets
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          2 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Kubernetes users: don’t get bitten by rate limits.
</p>
  </article>
</div>

    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/post/programming-humans" rel="permalink">Programming humans
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          2 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Language is I/O of the mind
</p>
  </article>
</div>

    
  </div>
</div>

  
  
</div>

      
    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    
      
        
          <li><a href="https://twitter.com/tomfernblog" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
        
      
        
          <li><a href="https://github.com/tomfern" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
        
          <li><a href="https://www.linkedin.com/in/pablo-tomas-fernandez-b6077514/" rel="nofollow noopener noreferrer"><i class="fab fa-brands fa-linkedin" aria-hidden="true"></i> LinkedIn</a></li>
        
      
    

    
      <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2024 <a href="https://tomfern.com">Chaos is order undeciphered</a>. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>









  </body>
</html>
