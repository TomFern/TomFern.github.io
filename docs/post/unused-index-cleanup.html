<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Unused Index cleanup | Chaos is order undeciphered</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="Unused Index cleanup" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Removing unused indexes for improved performance." />
<meta property="og:description" content="Removing unused indexes for improved performance." />
<link rel="canonical" href="https://tomfern.com/post/unused-index-cleanup" />
<meta property="og:url" content="https://tomfern.com/post/unused-index-cleanup" />
<meta property="og:site_name" content="Chaos is order undeciphered" />
<meta property="og:image" content="https://tomfern.com/images/database.jpg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-01-09T16:15:00-03:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://tomfern.com/images/database.jpg" />
<meta property="twitter:title" content="Unused Index cleanup" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2019-01-09T16:15:00-03:00","datePublished":"2019-01-09T16:15:00-03:00","description":"Removing unused indexes for improved performance.","headline":"Unused Index cleanup","image":"https://tomfern.com/images/database.jpg","mainEntityOfPage":{"@type":"WebPage","@id":"https://tomfern.com/post/unused-index-cleanup"},"url":"https://tomfern.com/post/unused-index-cleanup"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://tomfern.com/feed.xml" title="Chaos is order undeciphered" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Chaos is order undeciphered</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a><a class="page-link" href="/images/">Shared static images</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Unused Index cleanup</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2019-01-09T16:15:00-03:00" itemprop="datePublished">Jan 9, 2019
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p><img src="/images/database.jpg" alt="" /></p>

<p>Fixing a query by finding the right index feels great, as if by magic, things are blazing fast again.</p>

<p>But indexes, like everything in life, needs balancing. As things inevitably change, some indexes will be left abandoned and unused.
What happens then? Well, the database engine must keep them updated regardless, that’s wasted I/O. They also take up space. Pruning indexes is
the life of any dba.</p>

<h2 id="unused-indexes-in-mysql">Unused Indexes in MySQL</h2>

<p>Fortunately in MySQL has are two great tools: the <em>performance_schema</em>, which collects all kind of metrics and the <em>sys</em> schema which offers easier-to-read views.</p>

<p>The first thing to do is ensure that performance_schema is enabled and configured. There is a global configuration setting to enable it, requires restart to take effect.</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code># my.cnf
# ~~~~~~

[mysqld]
performance_schema=ON
</code></pre></div></div>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-- check if performance_schema is enabled
select @@performance_schema;
</code></pre></div></div>

<p>Then there is the runtime configuration to control what types of events to log. This is quite a complex subject because there is so many knobs to turn.</p>

<p>We’ll cheat, we have indexes to delete, no time to be reading manuals. MySQL Workbench has a <em>Performance Schema Setup</em> wizard.</p>

<p><img src="/images/performance_schema_setup.png" alt="performance schema setup" /></p>

<p><img src="/images/sys_installer.png" alt="installing the sys schema" /></p>

<p>Setting the slider to at least <em>Server Default</em> should be enough.</p>

<p><img src="/images/performance_schema_slider.png" alt=" cheat mode: enabled" /></p>

<h2 id="the-catch">The Catch</h2>

<p>Once everything is set up, we’ll find unused indexes in a view.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">sys</span><span class="p">.</span><span class="n">schema_unused_indexes</span>
</code></pre></div></div>

<p>The documentation states:</p>

<blockquote>
  <p>The <a href="https://dev.mysql.com/doc/refman/8.0/en/sys-schema-unused-indexes.html">schema_unused_indexes</a> View</p>

  <p>These views display indexes for which there are no events, which indicates that they are not being used. By default, rows are sorted by schema and table.</p>

  <p>This view is most useful when the server has been up and processing long enough that its workload is representative. Otherwise, presence of an index in this view may not be meaningful.</p>
</blockquote>

<p>At first glance it seems that we need only to check that the server has been running for some time,
i.e. the performance counters are reset on service restart.</p>

<p>That’s not entirely true, because all the counters for a particular table are also reset when any of its indexes are <strong>modified</strong>.
Doing any <code class="language-plaintext highlighter-rouge">alter table [add|remove] index</code>, marks all the other indexes on that table table as unused.</p>

<p>If you wish to have some fun test it yourself:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">create</span> <span class="k">database</span> <span class="n">super</span><span class="p">;</span>
<span class="k">create</span> <span class="k">table</span> <span class="n">super</span><span class="p">.</span><span class="n">heroes</span> <span class="p">(</span>
  <span class="n">name</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">45</span><span class="p">)</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
  <span class="n">hability</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">45</span><span class="p">)</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
  <span class="k">key</span><span class="p">(</span><span class="n">name</span><span class="p">),</span>
  <span class="k">key</span><span class="p">(</span><span class="n">hability</span><span class="p">)</span>
<span class="p">);</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">super</span><span class="p">.</span><span class="n">heroes</span> <span class="k">values</span>
<span class="p">(</span><span class="s1">'the flash'</span><span class="p">,</span><span class="s1">'speed'</span><span class="p">),</span>
<span class="p">(</span><span class="s1">'aquaman'</span><span class="p">,</span><span class="s1">'fish language'</span><span class="p">),</span>
<span class="p">(</span><span class="s1">'batman'</span><span class="p">,</span><span class="s1">'rich'</span><span class="p">),</span>
<span class="p">(</span><span class="s1">'superman'</span><span class="p">,</span><span class="s1">'all of them'</span><span class="p">);</span>

<span class="c1">-- use the index and check the counters</span>
<span class="k">select</span> <span class="n">name</span> <span class="k">from</span> <span class="n">super</span><span class="p">.</span><span class="n">heroes</span><span class="p">;</span>
<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">sys</span><span class="p">.</span><span class="n">schema_unused_indexes</span><span class="p">;</span>

<span class="c1">-- any one of these resets the index usage counters</span>
<span class="k">alter</span> <span class="k">table</span> <span class="n">super</span><span class="p">.</span><span class="n">heroes</span> <span class="k">add</span> <span class="k">key</span> <span class="n">name_hability</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">hability</span><span class="p">);</span>
<span class="k">alter</span> <span class="k">table</span> <span class="n">super</span><span class="p">.</span><span class="n">heroes</span> <span class="k">drop</span> <span class="k">key</span> <span class="n">name_hability</span><span class="p">;</span>
</code></pre></div></div>

<h2 id="related-links">Related Links</h2>

<ul>
  <li>performance_schema quickstart: <a href="https://dev.mysql.com/doc/mysql-perfschema-excerpt/8.0/en/performance-schema-quick-start.html">https://dev.mysql.com/doc/mysql-perfschema-excerpt/8.0/en/performance-schema-quick-start.html</a></li>
  <li>performance_schema config: <a href="https://dev.mysql.com/doc/mysql-perfschema-excerpt/8.0/en/performance-schema-runtime-configuration.html">https://dev.mysql.com/doc/mysql-perfschema-excerpt/8.0/en/performance-schema-runtime-configuration.html</a></li>
  <li>schema_unused_indexes: <a href="https://dev.mysql.com/doc/refman/8.0/en/sys-schema-unused-indexes.html">https://dev.mysql.com/doc/refman/8.0/en/sys-schema-unused-indexes.html</a></li>
</ul>

<h2 id="a-final-word">A Final Word</h2>

<p>Here’s my general strategy:</p>

<ul>
  <li>Backup the tables, or at the very least export the index definitions (just in case)</li>
  <li>Ensure that both server has been running for enough time <strong>and</strong> that the table has not been modified recently</li>
</ul>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>show table status from &lt;SCHEMA&gt; where name = &lt;TABLE&gt;
</code></pre></div></div>

<ul>
  <li>Save the list of the unused indexes somewhere safe, you’ll probably lose it after modifying the table</li>
</ul>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>create table unused_backup as select * from sys.schema_unused_indexes
</code></pre></div></div>

<ul>
  <li>Delete the unused indexes</li>
</ul>

<p>Hope that helps.</p>

<p>Tomas</p>

  </div><a class="u-url" href="/post/unused-index-cleanup" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Chaos is order undeciphered</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Chaos is order undeciphered</li><li><a class="u-email" href="mailto:contact (at) tomfern.com">contact (at) tomfern.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/tomfern"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">tomfern</span></a></li><li><a href="https://www.twitter.com/tomfernblog"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">tomfernblog</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Technical writer at Semaphore CI/CD</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
