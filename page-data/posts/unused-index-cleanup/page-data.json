{"componentChunkName":"component---src-templates-post-template-js","path":"/posts/unused-index-cleanup","result":{"data":{"markdownRemark":{"id":"2fb6d990-00a1-5e58-935d-3923f4d93c9f","html":"<p>Fixing a query by finding the right index feels great, as if by magic, things are blazing fast again.</p>\n<p>But indexes, like everything in life, needs balancing. As things inevitably change, some indexes will be left abandoned and unused.\nWhat happens then? Well, the database engine must keep them updated regardless, that’s wasted I/O. They also take up space. Pruning indexes is\nthe life of any dba.</p>\n<h2 id=\"unused-indexes-in-mysql\" style=\"position:relative;\"><a href=\"#unused-indexes-in-mysql\" aria-label=\"unused indexes in mysql permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Unused Indexes in MySQL</h2>\n<p>Fortunately in MySQL has are two great tools: the <em>performance\\</em>schema<em>, which collects all kind of metrics and the _sys</em> schema which offers easier-to-read views.</p>\n<p>The first thing to do is ensure that performance_schema is enabled and configured. There is a global configuration setting to enable it, requires restart to take effect.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># my.cnf\n# ~~~~~~\n\n[mysqld]\nperformance_schema=ON</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">-- check if performance_schema is enabled\nselect @@performance_schema;</code></pre></div>\n<p>Then there is the runtime configuration to control what types of events to log. This is quite a complex subject because there is so many knobs to turn.</p>\n<p>We’ll cheat, we have indexes to delete, no time to be reading manuals. MySQL Workbench has a <em>Performance Schema Setup</em> wizard.</p>\n<p>{{&#x3C; figure src=“/img/performance<em>schema</em>setup.png” caption=“Figure 1: performance schema setup” >}}</p>\n<p>{{&#x3C; figure src=“/img/sys_installer.png” caption=“Figure 2: installing the sys schema” >}}</p>\n<p>Setting the slider to at least <em>Server Default</em> should be enough.</p>\n<p>{{&#x3C; figure src=“/img/performance<em>schema</em>slider.png” caption=“Figure 3: cheat mode: enabled” >}}</p>\n<h2 id=\"the-catch\" style=\"position:relative;\"><a href=\"#the-catch\" aria-label=\"the catch permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>The Catch</h2>\n<p>Once everything is set up, we’ll find unused indexes in a view.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> sys<span class=\"token punctuation\">.</span>schema_unused_indexes</code></pre></div>\n<p>The documentation states:</p>\n<blockquote>\n<p>The <a href=\"https://dev.mysql.com/doc/refman/8.0/en/sys-schema-unused-indexes.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">schema_unused_indexes</a> View</p>\n<p>These views display indexes for which there are no events, which indicates that they are not being used. By default, rows are sorted by schema and table.</p>\n<p>This view is most useful when the server has been up and processing long enough that its workload is representative. Otherwise, presence of an index in this view may not be meaningful.</p>\n</blockquote>\n<p>At first glance it seems that we need only to check that the server has been running for some time,\ni.e. the performance counters are reset on service restart.</p>\n<p>That’s not entirely true, because all the counters for a particular table are also reset when any of its indexes are <strong>modified</strong>.\nDoing any <code class=\"language-text\">alter table [add|remove] index</code>, marks all the other indexes on that table table as unused.</p>\n<p>If you wish to have some fun test it yourself:</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">create</span> <span class=\"token keyword\">database</span> super<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">create</span> <span class=\"token keyword\">table</span> super<span class=\"token punctuation\">.</span>heroes <span class=\"token punctuation\">(</span>\n  name <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">45</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">not</span> <span class=\"token boolean\">null</span><span class=\"token punctuation\">,</span>\n  hability <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">45</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">not</span> <span class=\"token boolean\">null</span><span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">key</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">key</span><span class=\"token punctuation\">(</span>hability<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">insert</span> <span class=\"token keyword\">into</span> super<span class=\"token punctuation\">.</span>heroes <span class=\"token keyword\">values</span>\n<span class=\"token punctuation\">(</span><span class=\"token string\">'the flash'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'speed'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">(</span><span class=\"token string\">'aquaman'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'fish language'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">(</span><span class=\"token string\">'batman'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'rich'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">(</span><span class=\"token string\">'superman'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'all of them'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">-- use the index and check the counters</span>\n<span class=\"token keyword\">select</span> name <span class=\"token keyword\">from</span> super<span class=\"token punctuation\">.</span>heroes<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> sys<span class=\"token punctuation\">.</span>schema_unused_indexes<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">-- any one of these resets the index usage counters</span>\n<span class=\"token keyword\">alter</span> <span class=\"token keyword\">table</span> super<span class=\"token punctuation\">.</span>heroes <span class=\"token keyword\">add</span> <span class=\"token keyword\">key</span> name_hability<span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span>hability<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">alter</span> <span class=\"token keyword\">table</span> super<span class=\"token punctuation\">.</span>heroes <span class=\"token keyword\">drop</span> <span class=\"token keyword\">key</span> name_hability<span class=\"token punctuation\">;</span></code></pre></div>\n<h2 id=\"related-links\" style=\"position:relative;\"><a href=\"#related-links\" aria-label=\"related links permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Related Links</h2>\n<ul>\n<li>performance_schema quickstart: <a href=\"https://dev.mysql.com/doc/mysql-perfschema-excerpt/8.0/en/performance-schema-quick-start.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://dev.mysql.com/doc/mysql-perfschema-excerpt/8.0/en/performance-schema-quick-start.html</a></li>\n<li>performance_schema config: <a href=\"https://dev.mysql.com/doc/mysql-perfschema-excerpt/8.0/en/performance-schema-runtime-configuration.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://dev.mysql.com/doc/mysql-perfschema-excerpt/8.0/en/performance-schema-runtime-configuration.html</a></li>\n<li>schema_unused_indexes: <a href=\"https://dev.mysql.com/doc/refman/8.0/en/sys-schema-unused-indexes.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://dev.mysql.com/doc/refman/8.0/en/sys-schema-unused-indexes.html</a></li>\n</ul>\n<h2 id=\"a-final-word\" style=\"position:relative;\"><a href=\"#a-final-word\" aria-label=\"a final word permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>A Final Word</h2>\n<p>Here’s my general strategy:</p>\n<ul>\n<li>Backup the tables, or at the very least export the index definitions (just in case)</li>\n<li>Ensure that both server has been running for enough time <strong>and</strong> that the table has not been modified recently</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">show table status from &lt;SCHEMA&gt; where name = &lt;TABLE&gt;</code></pre></div>\n<ul>\n<li>Save the list of the unused indexes somewhere safe, you’ll probably lose it after modifying the table</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">create table unused_backup as select * from sys.schema_unused_indexes</code></pre></div>\n<ul>\n<li>Delete the unused indexes</li>\n</ul>\n<p>Hope that helps.</p>\n<p>Tomas</p>","fields":{"slug":"/posts/unused-index-cleanup","tagSlugs":["/tag/mysql/","/tag/tuning/"]},"frontmatter":{"date":"2019-01-09T16:15:00-03:00","description":"Removing unused indexes for improved performance.","tags":["mysql","tuning"],"title":"Unused Index cleanup","socialImage":"/social/database.jpg"}}},"pageContext":{"slug":"/posts/unused-index-cleanup"}}}